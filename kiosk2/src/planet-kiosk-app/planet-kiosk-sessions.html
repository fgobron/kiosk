<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./planet-kiosk-activity-behavior.html">

<dom-module id="planet-kiosk-sessions">
  <template>
    <style include="planet-kiosk-page-styles">
      :host {
        width:100%;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        --paper-fab-background: none;
        --paper-fab-keyboard-focus-background: transparent;
        --paper-fab: {
          padding:0;
          width: 9em;
          height: 9em;
        }
      }

      /* Days */
      .days {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }

      .days paper-fab[normal] {
        box-shadow: none;
        margin: 0.8em;
        color: var(--planet-color-theme-btn);
        --paper-fab-label: {
          font-size: 2.3em;
          font-family: var(--planet-font-family-book);
          width: 2.2em;
          white-space: normal;
        }
      }

      .days paper-fab[activated] {
        background-color:var(--planet-color-theme-primary);
        color: var(--planet-color-theme-opposite);
      }

      .days paper-fab[disabled] {
        background: none;
        opacity: 0.2;
      }

      .days paper-fab[pressed] {
        box-shadow: none;
      }

      .days paper-fab.today {
        border-radius: 4.4em;
        width:20em;
        height: 8em;
        --paper-fab-label: {
          font-size: 2.3em;
          font-family: var(--planet-font-family-book);
          width: auto;
        }
      }

      /* Hours */
      .hours {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        max-width: 58em;
        margin-bottom: 2em;
      }
      .hours paper-fab[normal] {
        box-shadow: none;
        margin: 1.2em;
        color: var(--planet-color-theme-btn);
        --paper-fab-label: {
          font-size: 2.3em;
          font-family: var(--planet-font-family-book);
          white-space: normal;
        }
      }

      .hours paper-fab[activated] {
        background-color:var(--planet-color-theme-primary);
        color: var(--planet-color-theme-opposite);
      }

      .hours paper-fab[disabled] {
        background: none;
        color: var(--planet-color-theme-btn);
        opacity: 0.2;
      }

      .hours paper-fab[pressed] {
        box-shadow: none;
      }

    </style>

    <div class="days">
      <template id="dateslist" is="dom-repeat" items="[[dates]]">
        <paper-fab label="[[_getDayLabel(item.date)]]" on-tap="_dayHandler" normal=""></paper-fab>
      </template>
    </div>

    <hr noshade="">

    <div class="hours">
      <template id="hourslist" is="dom-repeat" items="[[hours]]">
        <paper-fab label="[[_getHourLabel(item)]]" on-tap="_hourHandler" normal="" disabled="[[_isOutOfavailability(selectedQuantity, item.availability)]]"></paper-fab>
      </template>
    </div>

  </template>

  <script>
    Polymer({
      is: 'planet-kiosk-sessions',
      behaviors: [
        AppLocalizeBehavior,
        ActivityBehavior
      ],
      properties: {
        selectedQuantity: {
          type: Number
        },
        dates: {
          type: Array
        },
        hours: {
          type: Array
        },
        // Index of selected day
        day: {
          type: Number
        },
        // Index of selected hour
        hour: {
          type: Number
        }
      },
      // Common
      observers: [
        '_dayChanged(day)',
        '_hourChanged(hour)'
      ],
      _highlightItem: function (index, className) {
        // Reset previous active day
        this.async(function() {
          var previousActivated = Polymer.dom(this.root).querySelector('.' + className + ' paper-fab[activated]');
          var currentActivated =  Polymer.dom(this.root).querySelectorAll('.' + className + ' paper-fab')[index];
          if (previousActivated !== null) {
            previousActivated.removeAttribute('activated');
          }
          currentActivated.setAttribute('activated', true);
        });
      },
      _getFirstAvailableHour: function () {
        var hours = this.hours;
        var len = hours.length;
        for (var i=0; i<len; i++) {
          if (this.get('selectedQuantity') <= hours[i].availability) {
            return i;
          }
        }
        return null;
      },
      // Days part
      _dayChanged: function (day) {
        this.set('hours', null);
        this.async(function() {
          if (day !== null) {
            this.set('hours', this._getHours(day));
            var detail = document.querySelector('planet-kiosk-detail');
            if (detail && detail.get('visible')){
              this._highlightItem(day, 'days');
              this.set('hour', null);
              this.set('hour', this._getFirstAvailableHour());
            }
          }
        });

      },
      _getDayLabel: function (date) {
        var dayOfWeek = moment(date).format('ddd').substr(0,3).toUpperCase();
        var DD = moment(date).format('DD');
        return dayOfWeek.concat(" ").concat(DD);
      },
      _dayHandler: function (e) {
        this.set('day', e.model.index);
      },
      // Hours part
      _getHours: function (day) {
        var hours = [];
        if (day !== null) {
          hours = this.dates[day].hours;
        }
        return hours;
      },
      _getHourLabel: function (hour) {
        return moment(hour.begin, 'HH:mm:ss').format('HH:mm');
      },
      _hourHandler: function (e) {
        this.set('hour', e.model.index);
      },
      _hourChanged: function (hour) {
        var detail = document.querySelector('planet-kiosk-detail');
        if (hour !== null) {
          if (detail && detail.get('visible')){
            this._highlightItem(hour, 'hours');
          }
        }
      },
      _isOutOfavailability: function (selectedQuantity, availability) {
        return selectedQuantity > Number(availability);
      },
      _onQuantityChange: function (e) {
        // Force day mutation for sub-template refresh
        var day = this.get('day');
        this.set('day', null);
        this.async(function() {
          this.set('day', day);
        });
      }
    });
  </script>
</dom-module>