<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Components !-->
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<!-- Behaviors !-->
<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./planet-kiosk-login-behavior.html">

<dom-module id="planet-kiosk-login-qrscan">
  <template>
    <style include="iron-flex iron-flex iron-flex-alignment planet-kiosk-page-styles planet-kiosk-form-styles">

      :host {
        --circular-progress-font-size: 0.75em;
      }

      .content {
        text-align: center;
        margin: 55em 0 0 0;
      }

      iron-icon {
        width:30em;
        height:30em;
        margin-bottom: 2em;
        color: var(--planet-color-theme-primary);
      }

      .message {
        font-size: 4em;
        font-family: var(--planet-font-family-book);
        color: var(--planet-color-theme-message);
        text-align: center;
        margin: 3em 3em 0;
      }

      .buttons {
        margin-top: 8em;
      }

      #arrow {
        position: absolute;
        bottom: 5em;
        right: 5em;
        width: 20em;
        height: 20em;
        animation: grow 1.5s infinite;
      }

      @keyframes grow {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.2);
        }

        100% {
          transform: scale(1);
        }
      }

      #arrow path {
        fill: var(--planet-color-theme-primary);
      }

    </style>
    <iron-meta-query id="appconfig" key="config" value="{{appconfig}}"></iron-meta-query>
    <div>
      <h2>[[localize('login_hub')]]</h2>
      <div class="content">
        <iron-icon icon="login:qrcode"></iron-icon>
        <p class="message">[[localize('login_qrcode_subtitle')]]</p>
      </div>
      <svg viewBox="0 0 32 32" id="arrow">
        <path d="M32 9l-8 8-17-17-7 7 17 17-8 8h23v-23z"></path>
      </svg>
      <!--div class="buttons layout vertical center">
        <paper-button class="button primary cancel" on-tap="_cancel">[[localize('login_cancel_button')]]</paper-button>
      </div>-->
    </div>
    <iron-ajax
        id="loginrequest"
        url="[[appconfig.api]]/getUserKiosk"
        on-response="didReceiveResponse"
        on-error="fail">
    </iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'planet-kiosk-login-qrscan',
      behaviors : [
        AppLocalizeBehavior,
        LoginBehavior
      ],
      properties: {
        visible: {
          type: Boolean,
          observer: '_visibilityChanged'
        },
        state: {
          type: String,
          value: 'initial'
        },
        bookingId: String,
        _scanDuration: {
          type: Number,
          value: 30
        },
        _popinText: {
          type: String,
          value: ''
        },
        _errorButtons: {
          type: Array,
          value: []
        }
      },
      scan: function() {
        if (MBirdSdk.isConnected()) {
          // Start scaning
          MBirdSdk.Scanner.Scan(this.get('_scanDuration')).then(function (result) {
            this.set('bookingId', result);
            this._successScan();
          }.bind(this)).catch(function (error) {
            this.fail();
          }.bind(this));
        } else {
          this.fail();
        }
      },
      fail: function () {
        var buttons = [
          {
            label: this.localize('login_error_abandon_button'),
            class: 'button primary cancel',
            callback: this.cancel.bind(this)
          },
          {
            label: this.localize('login_error_tryagain_button'),
            class: 'button primary confirm',
            callback: this.retry.bind(this)
          }
        ];
        this.showPopIn(this.localize('login_qrcode_error_title'), this.localize('login_qrcode_error_line1'), this.localize('login_qrcode_error_line2'), buttons);
      },
      retry: function() {
        this.scan();
      },
      _visibilityChanged: function (visibility) {
        if (visibility) {
          this.scan();
        }
      },
      _successScan: function () {
        this.showPopIn('', this.localize('login_authenticating'), '', []);
        // Setup xhr
        var loginRequest = this.$.loginrequest;
        loginRequest.headers = globals.headers;
        loginRequest.params.booking = this.get('bookingId');
        loginRequest.generateRequest();
      }
    });
  </script>
</dom-module>