<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./generic/app-tag-manager.html">
<link rel="import" href="./generic/app-tag-manager-behaviour.html">

<link rel="import" href="./common/planet-kiosk-icons.html">
<link rel="import" href="./common/planet-kiosk-page-styles.html">
<link rel="import" href="./common/planet-kiosk-popin-styles.html">
<link rel="import" href="./common/planet-kiosk-form-styles.html">
<link rel="import" href="./common/planet-kiosk-buttons-styles.html">

<link rel="import" href="./pmr/planet-kiosk-pmr-behavior.html">
<link rel="import" href="./planet-kiosk-activities-behavior.html">
<link rel="import" href="./planet-kiosk-lang.html">
<link rel="import" href="./planet-kiosk-hub.html">
<link rel="import" href="./planet-kiosk-identification.html">
<link rel="import" href="./planet-kiosk-login-info.html">
<link rel="import" href="./planet-kiosk-login-qrscan.html">
<link rel="import" href="./planet-kiosk-detail.html">
<link rel="import" href="./planet-kiosk-az.html">
<link rel="import" href="./planet-kiosk-age.html">
<link rel="import" href="./planet-kiosk-todonow.html">
<link rel="import" href="./planet-kiosk-schedule.html">
<link rel="import" href="./planet-kiosk-basket.html">
<link rel="import" href="./planet-kiosk-payment.html">
<link rel="import" href="./planet-kiosk-map.html">
<link rel="import" href="./planet-kiosk-outage.html">
<link rel="import" href="./planet-kiosk-tabbar.html">

<link rel="import" href="./planet-kiosk-loader.html">
<link rel="import" href="./planet-kiosk-inactivity.html">
<link rel="import" href="./planet-kiosk-cart.html">
<link rel="import" href="./planet-kiosk-clock.html">

<dom-module id="planet-kiosk-app">  
  <template>
    <style>
      planet-kiosk-clock {
        position: absolute;
        top : 0.5em;
        left: 0.5em;
      }
      
      /* PMR Mode override */
      iron-pages.pmr {        
        display: block;
        margin-top: 135em;
        overflow: scroll;
        height:52em;
      }
      
      planet-kiosk-clock.pmr {
        top: 44em;
      }
    </style>

    <app-tag-manager></app-tag-manager>
    <app-location route="{{_route}}" use-hash-as-path></app-location>
    <app-route
        route="{{_route}}"
        pattern="/:page"
        data="{{_pageData}}"
        tail="{{_subRoute}}"></app-route>
    <app-route
        route="{{_subRoute}}"
        pattern="/:code"
        data="{{_idData}}"
        query-params="{{queryParams}}"></app-route>

    <app-scrollpos-control selected="[[_pageData.page]]"></app-scrollpos-control>
    
    <iron-pages selected="[[_pageData.page]]" attr-for-selected="name" selected-attribute="visible" on-iron-select="_pageSelected" class$="[[_getPMRClass(pmr)]]">
      
      <planet-kiosk-lang name="lang" language="[[language]]" pmr="{{pmr}}"></planet-kiosk-lang>
      
      <planet-kiosk-hub name="hub" language="[[language]]" pmr="{{pmr}}"></planet-kiosk-hub>
      
      <planet-kiosk-identification name="identification" language="[[language]]"></planet-kiosk-identification>
      
      <planet-kiosk-login-info name="login" language="[[language]]"></planet-kiosk-login-info>

      <planet-kiosk-login-qrscan name="qrlogin" language="[[language]]"></planet-kiosk-login-qrscan>

      <planet-kiosk-az name="az" language="[[language]]" activities="[[activities]]"></planet-kiosk-az>
      
      <planet-kiosk-age name="age" language="[[language]]" activities="[[activities]]"></planet-kiosk-age>

      <planet-kiosk-todonow name="now" language="[[language]]" activities="[[activities]]"></planet-kiosk-todonow>

      <planet-kiosk-schedule name="schedule" language="[[language]]" activities="[[activities]]"></planet-kiosk-schedule>

      <planet-kiosk-detail name="detail" language="[[language]]" activity="[[_getActivity(activities, _idData.code)]]"></planet-kiosk-detail>
      
      <planet-kiosk-basket name="basket" language="[[language]]" activities=[[activities]] cart="[[cart]]" nb-items="[[nbItems]]" total="[[total]]"></planet-kiosk-basket>
      
      <planet-kiosk-payment name="payment" language="[[language]]"></planet-kiosk-payment>
      
      <planet-kiosk-map name="map" language="[[language]]"></planet-kiosk-map>
      
      <planet-kiosk-outage name="outage" language="[[language]]"></planet-kiosk-outage>
      
    </iron-pages>
    
    <planet-kiosk-clock class$="[[_getPMRClass(pmr)]]"></planet-kiosk-clock>
    
    <planet-kiosk-loader id="loader" language="[[language]]" with-backdrop no-cancel-on-outside-click></planet-kiosk-loader>
    <planet-kiosk-inactivity id="inactivity" language="[[language]]" with-backdrop></planet-kiosk-inactivity>
    <planet-kiosk-cart id="cart" cart="{{cart}}" nb-items="{{nbItems}}" total="{{total}}"></planet-kiosk-cart>

    <planet-kiosk-tabbar
            hidden="[[_isTabBarHidden(_pageData.page)]]"
            collection="[[_getTabBarCollection(_pageData.page)]]"
            language="[[language]]"
            nb-cart-items="[[nbItems]]"
            highlighted-page="[[_pageData.page]]"
            pmr="{{pmr}}"
    >
    </planet-kiosk-tabbar>    
  </template>
  <script>

  Polymer({

    is: 'planet-kiosk-app',
    
    behaviors: [
      AppLocalizeBehavior,
      TagManagerBehavior,
      ActivitiesBehavior,
      PMRBehavior
    ],
    
    properties: {
      
      _route: Object,

      _subRoute: Object,

      _pageData: Object,

      _idData: Object,
      
      _pageInfos: {
        type:Object,
        value: {
          'default': {
            hiddenTabBar:false,
            collection: 'full'
          },
          'qrlogin':{
            hiddenTabBar:true
          },
          'payment':{
            hiddenTabBar:true
          },
          'outage':{
            hiddenTabBar:true
          },
          'lang':{
            hiddenTabBar:false,
            hiddenTabBarNoPmr:true,
            collection:'pmr'
          }
        }
      },
      
      activities: Object,
      
      queryParams: Object,
      
      cart: Array,
      
      nbItems: Number,
      
      total: Number,
      
      pmr: {
        type: Boolean,
        value: false        
      }      
    },
    attached: function () {
      this.async(function() {        
        if (this._route.path !== 'lang') {
          this.set('_route.path', '/lang');
        }
      });
      if (MBirdSdk.isConnected()) {        
        this._checkInactivity();
      }            
    },    
    _getActivity: function() {
      if (this.activities && this._idData.code) {        
        var ref = this._getActivityIndexByCode(this._idData.code);        
        var activity = this.activities[ref];
        return activity;
      }
      return null;
    },
    _pageSelected: function(e) {           
      var page = e.detail.item;      
      var name = page.getAttribute('name');
      // Previous list backup
      if (name === 'az' || name === 'age' || name === 'now' || name === 'schedule') {
        globals.lastList = name;
      }
      // Tag
      if(name === 'lang') {
        // Start Session        
        this.async(function() {        
          this.trackEvent('Kiosk', 'language selection', 'activate session', 'start');
        }, 300);
      }
      if(name === 'outage') {
        // Start Session outage       
        this.async(function() {        
          this.trackEvent('Kiosk', 'outage', 'connectivity or peripherals default', 'end');
        }, 300);
      }
    },    
    _checkInactivity: function () {      
      MBirdSdk.App.OnInactivity(function () {        
        this.$.inactivity.open();
        this.trackEvent('Acrelec Notification', 'idle', 'inactivity', 'noevent');
      }.bind(this));
    },
    _isPmrAvailable: function () {
      return globals.pmr;
    },
    _isTabBarHidden: function (pageName) {
      var pageInfos = this.get('_pageInfos');

      if (pageInfos[pageName]) {
        if (pageInfos[pageName].hiddenTabBar) {
          return true
        }
        if (pageInfos[pageName].hiddenTabBarNoPmr && !this._isPmrAvailable()) {
          return true;
        }
      }
      return false;
    },
    _getTabBarCollection: function (pageName) {
      var pageInfos = this.get('_pageInfos');

      if (pageInfos[pageName] && pageInfos[pageName].collection) {
        return pageInfos[pageName].collection;
      }

      return pageInfos.default.collection;
    }    
  });

  </script>
</dom-module>
