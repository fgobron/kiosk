<script>
  /**
   * Login helper
   *
   * @polymerBehavior LoginBehavior
   */
  LoginBehavior = {
    _popIn: null,
    properties: {

    },
    attached: function () {
      // Init error popIn
      this._popIn = document.createElement('planet-kiosk-error-popin');
      this._popIn.set('withBackdrop', true);
      this._popIn.set('noCancelOnOutsideClick', true);
      // Init information popin
      this.appendChild(this._popIn);
    },
    cancel: function () {
      window.history.back();
    },
    didReceiveResponse: function(request) {
      var response = request.detail.response;
      if (typeof(response.status) !== 'undefined') {
        var status = response.status;
        var results = response.results;
        switch (status.retC) {
          case 0:
            globals.token = results.token;
            globals.bookingId = results.bookingId;
            globals.cottageNumbers = results.cottageNumbers;
            globals.uid = results.uid;
            this._trackAuthentification();
            this.redirectAfterLogin();
            break;
          case -231:
            if (this.authByDate) {
              this.authByDate();
            }
            break;
          default:
            this.fail();
        }
      } else {
        this.fail();
      }
    },
    redirectAfterLogin: function () {
      this.showPopIn('', this.localize('login_success'), '', '');
      this.async(function() {
        this.hidePopIn();
        var identification = document.querySelector('planet-kiosk-identification');
        var action = identification.get('action');
        switch (action) {
          case 'payment':
            var basket = document.querySelector('planet-kiosk-basket');
            globals.router.set('route.path', '/basket');
            basket.doPayment();
            break;
          default:
            // Detail
            var detail = document.querySelector('planet-kiosk-detail');
            detail.addPendingItem();
        }
      }, 2000);
    },
    hidePopIn: function() {
      if (this._popIn) {
        this._popIn.close();
      }
    },
    showPopIn: function(title, line1, line2, buttons) {
      var popIn = this._popIn;

      if (popIn) {
        popIn.set('title', title);
        popIn.set('line1', line1);
        popIn.set('line2', line2);

        popIn.set('buttons', buttons);
        this._popIn.center();
        this._popIn.open();
      }
    },
    _trackAuthentification: function() {
      var layer = {
        'eventCategory': 'Login',
        'eventAction': 'authentification',
        'eventLabel': 'success',
        'event': 'noevent',
        'uid': globals.uid     
      };
      dataLayer.push(layer);
    }
  };
</script>