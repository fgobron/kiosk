<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./generic/app-tag-manager-behaviour.html">

<link rel="import" href="./pmr/planet-kiosk-pmr-behavior.html">

<link rel="import" href="./common/planet-kiosk-icons.html">

<link rel="import" href="./planet-kiosk-abandon.html">

<dom-module id="planet-kiosk-tabbar">
  <template>
    <style include="iron-flex iron-flex-alignment">      
      :host {
        --paper-badge : {
          background: var(--planet-color-theme-warning);
          font-size: 1.2em;
          height: 1.5em;
          width: 1.5em;
          margin-bottom: -4em;
          margin-right: 4em;
        };

      }

      app-toolbar {
        position: fixed;
        background-color: var(--planet-color-theme-primary);
        width:100%;
        max-width: 54em;
        height: 5.5em;
        bottom: 0;
        padding: 0;
      }
      
      paper-button {
        --paper-button: {
          @apply(--layout-vertical);
          @apply(--layout-center-center);
        };
        font-family: var(--planet-font-family-book);
        font-size: 1.1em;
        text-transform: none;
        color: var(--planet-color-theme-opposite);
        background-color: var(--planet-color-theme-primary);        
        height: 5em;
        padding: 0;
        margin: 0;
        border-left: solid 1px var(--planet-color-theme-opposite);
        text-align: center;
      }
      
      paper-button.s {
        width: 8.181818182em;
      }
      
      paper-button.m {
        width: 9.818181818em;
      }
      
      paper-button.l {
        width: 12.272727273em;
      }
      
      paper-button.xl {
        width: 16.363636364em;
      }
      
      paper-button span.highlighted {
        display: block;
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 0.4em;
        background-color: var(--planet-color-theme-opposite);
      }
      
      paper-button.warning {
        background-color: var(--planet-color-theme-warning);
      }
      
      paper-button.last,
      paper-button.first {
        border-left: none;
      }
      
      iron-icon {
        width:2em;
        height:2em;
        margin: 0.4em 0;
      }
      
      a {
        text-decoration: none;
      }

      .badged {
        z-index: 1000;
      }
      
      /* PMR Mode override */
      app-toolbar.pmr {
        height: 2.75em;
      }
      
      app-toolbar.pmr paper-button {
        height: 2.5em;        
        @apply(--layout-horizontal);          
        @apply(--layout-center);
      }
      
      app-toolbar.pmr paper-button iron-icon {
        margin-right: 0.5em;
      }
      
    </style>
    
    <template is="dom-if" if="[[_isEqualTo(collection, 'pmr')]]">
      <app-toolbar class$="horizontal layout center-justified [[_getPMRClass(pmr)]]">        
        <a href="#/pmr" on-tap="_trackPMR">
          <paper-button class="first m">
            <iron-icon icon="tabbar:pmr"></iron-icon>
            [[_getPMRWording(pmr)]]
          </paper-button>
        </a>        
      </app-toolbar>
    </template>
    
    <template is="dom-if" if="[[_isEqualTo(collection, 'full')]]">
      <app-toolbar id="toolbar" class$="[[_getPMRClass(pmr)]]">
        <a href="#/hub" on-tap="_trackNavigation">
          <paper-button class$="first [[size]]">
            <iron-icon icon="tabbar:home"></iron-icon>
            [[localize('tabbar_home')]]
            <span hidden$="[[!_isHighlighted('hub', highlightedPage)]]" class="highlighted"></span>
          </paper-button>
        </a>
        <a href="#/basket" hidden="[[!_isPaymentAvailable()]]" on-tap="_trackNavigation" class="badged">
          <paper-button class$="[[size]]" id="basket">
            <iron-icon icon="tabbar:basket"></iron-icon>
            [[localize('tabbar_basket')]]            
            <span hidden$="[[!_isHighlighted('basket', highlightedPage)]]" class="highlighted"></span>
          </paper-button>
          <template is="dom-if" if="[[_isBadgeDisplayed(nbCartItems)]]">
            <paper-badge for="basket" label="[[nbCartItems]]"></paper-badge>
          </template>
        </a>
        <a href="#/map" on-tap="_trackNavigation">
          <paper-button  class$="[[size]]">
            <iron-icon icon="tabbar:map"></iron-icon>
            [[localize('tabbar_map')]]
            <span hidden$="[[!_isHighlighted('map', highlightedPage)]]" class="highlighted"></span>
          </paper-button>
        </a>
        <a href="#/pmr" hidden="[[!_isPmrAvailable()]]" on-tap="_trackNavigation">
          <paper-button class$="[[size]]">
            <iron-icon icon="tabbar:pmr"></iron-icon>
            [[_getPMRWording(pmr)]]
          </paper-button>
        </a>        
        <paper-button class$="warning last [[size]]" on-tap="_reset">
          <iron-icon icon="tabbar:abandon"></iron-icon>
          [[localize('tabbar_abandon')]]
        </paper-button>
      </app-toolbar>
    </template>
    
    <planet-kiosk-abandon id="abandon" language="[[language]]" with-backdrop no-cancel-on-outside-click></planet-kiosk-abandon>
  </template>

  <script>  
  Polymer({
    is: 'planet-kiosk-tabbar',
    behaviors: [
      AppLocalizeBehavior,
      TagManagerBehavior,
      PMRBehavior
    ],
    properties: {
      highlightedPage: {
        type: String,
        value: ''
      },
      size: {
        type: String,
        value: ''
      },
      collection: String,
      nbCartItems: Number,
      pmr: {
        type:Boolean,
        notify: true
      }
    },
    listeners: {
        'tap': '_onGlobalTap',        
    },
    attached: function () {      
      this._setSize();      
    },
    _isPaymentAvailable: function () {
      return globals.payment;
    },
    _isPmrAvailable: function () {
      return globals.pmr;
    },
    _setSize: function () {
      if (globals.payment && globals.pmr) {        
        this.set('size','m');
      } else {
        if (globals.payment || globals.pmr) {
          this.set('size','l');  
        } else {
          this.set('size', 'xl');
        }        
      }
    },
    _isHighlighted: function (itemName, highlightedPage) {
      return highlightedPage === itemName;
    },
    _isEqualTo : function (collection, value) {
      return collection === value;
    },
    _onGlobalTap: function () {
      // restore empty queryParams for futur navigation
      // remove edit mode after detail activity modification in basket
      globals.router.set('queryParams', {});
    },
    _getPMRWording: function (pmr) {
      if (this.pmr) {
        return this.localize('tabbar_normal');
      } else {
        return this.localize('tabbar_pmr');
      }
    },
    _togglePMRMode: function () {
      if (this.pmr) {
        this.setDataLayerItem('type_session', 'normal');
        this.set('pmr', false);
      } else {
        this.setDataLayerItem('type_session', 'pmr');
        this.set('pmr', true);
      }
    },
    _trackPMR: function (e) {
      e.preventDefault();
      this.trackEvent('Language selection', 'pmr button', 'click', 'noevent');
      this._togglePMRMode();
    },
    _trackNavigation: function (e) {
      var target = e.currentTarget;
      var tab = target.getAttribute('href').replace('#/', '');
      this.trackEvent('Navigation bar', tab, 'click', 'noevent');
      if (tab === 'pmr') {
        e.preventDefault();
        this._togglePMRMode();        
      }      
    },
    _reset: function () {
      this.$.abandon.open();
      this.trackEvent('Navigation bar', 'abandon', 'click', 'noevent');
    },
    _isBadgeDisplayed: function (nbCartItems) {
      if (nbCartItems) {
        return true;
      }
      return false;
    }
  });

  </script>
</dom-module>