<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./generic/app-tag-manager-behaviour.html">

<link rel="import" href="./planet-kiosk-basket-item.html">
<link rel="import" href="./planet-kiosk-cgu.html">
<link rel="import" href="./planet-kiosk-basket-authentification.html">
<link rel="import" href="./planet-kiosk-basket-error.html">

<dom-module id="planet-kiosk-basket">
  <style include="iron-flex iron-flex iron-flex-alignment planet-kiosk-page-styles">
    :host {
      --info-pres : {
        font-size: 3em;
        font-family: var(--planet-font-family-book);
        color: var(--planet-color-theme-desc);
      }
      --cgu-pres: {
        font-size: 2em;
        font-family: var(--planet-font-family-roman);
        color: var(--planet-color-theme-title);
      }
      --total-pres: {
        font-size: 5em;
        font-family: var(--planet-font-family-roman);
        color: var(--planet-color-theme-price);
      }
      /* Checkbox */
      --paper-checkbox-size: 3em;
      --paper-checkbox-margin: 0 1em;
      --paper-checkbox-label: {
        @apply --cgu-pres;
        margin-right: 2em;
      }
      --paper-checkbox-checked-color: var(--planet-color-theme-primary);

    }

    .content {
      margin: 2em 5em;
      padding-bottom: 40em;
    }

    .summary:not([visible]),
    .empty:not([visible]){
      display: none;
    }

    .summary  {
      position: fixed;
      left: 0;
      bottom: 11em;
      width: 100%;
      border-top: 1px solid var(--planet-color-theme-border-sep);
      background-color: var(--planet-color-theme-mainbg);
    }

    .cgu-block {
      margin: 4em 5em;
      width: 68em;
    }

    .cgu-block.error {
      border: 2px solid red;
    }

    .total {
      position: absolute;
      top: 0;
      right: 1em;
      @apply --total-pres;
    }

    .buttons {
      margin: 8em 0;
    }

    .empty {
      height: 152em;
    }

    .empty p.info {
      @apply --info-pres;
    }
  </style>
  <template>
    <header>
      <h2>[[localize('basket_title')]] [[_getNbItemsLabel(nbItems)]]</h2>
    </header>

    <div class="content">
      <template id="cartList" is="dom-repeat" items="{{cart}}" as="entry">
        <planet-kiosk-basket-item entry="[[entry]]" index="[[index]]"></planet-kiosk-basket-item>
      </template>
      <div class="empty layout vertical center-center" visible$="[[!_hasItems]]">
        <p class="info">[[localize('basket_empty_title')]]</p>
        <paper-button class="primary confirm" on-tap="_close">[[localize('basket_close_button')]]</paper-button>
      </div>
    </div>

    <div class="summary" visible$="[[_hasItems]]">
      <div class="cgu-block">
        <paper-checkbox id="cgu" on-tap="_onCGUChanged">[[localize('basket_salesconditions')]]</paper-checkbox>
        <paper-button class="tertiary" on-tap="_openCGU">[[localize('basket_salesconditions_button')]]</paper-button>
      </div>
      <p class="total">[[localize('basket_price_total')]] [[total]] [[localize('activity_currency')]]</span>
      <div class="buttons layout horizontal center-justified">
        <paper-button class="primary cancel" on-tap="_cancel">[[localize('basket_continue_button')]]</paper-button>
        <paper-button class="primary confirm" on-tap="_confirm">[[localize('basket_payment_button')]]</paper-button>
      </div>
    </div>

    <planet-kiosk-cgu id="cgupopin" language="[[language]]" with-backdrop no-cancel-on-outside-click></planet-kiosk-cgu>
    <planet-kiosk-basket-authentification id="authentification" with-backdrop no-cancel-on-outside-click></planet-kiosk-basket-authentification>
    <planet-kiosk-basket-error id="error" with-backdrop no-cancel-on-outside-click></planet-kiosk-basket-error>

    <iron-meta-query id="appconfig" key="config" value="{{appconfig}}"></iron-meta-query>
    <iron-ajax id="basketrequest" method="POST" content-type="application/json" url="[[appconfig.api]]/setBookingParisBasket" on-response="_onBasketResponse" on-error="_onBasketError"></iron-ajax>

  </template>
  <script>
    Polymer({
      is: 'planet-kiosk-basket',
      behaviors: [
        AppLocalizeBehavior,
        TagManagerBehavior
      ],
      properties: {
        activities: {
          type: Object
        },
        cart: {
          type: Array,
          notify: true
        },
        nbItems: {
          type: Number
        },
        total: {
          type: Number
        },
        _hasItems: {
          type: Boolean,
          computed: '_computeHasItem(cart.length)'
        }
      },
      listeners: {
        'cart-delete-item': '_onCartdeleteItem',
        'cart-edit-item': '_onCartEditItem',
        'do-payment': 'doPayment'
      },
      _computeHasItem: function(cartLength) {
        return cartLength > 0;
      },
      _cancel: function() {
        globals.router.set('route.path', '/' + globals.lastList);
      },
      _close: function() {
        globals.router.set('route.path', '/hub');
      },
      _onCartdeleteItem: function(e) {
        globals.cart.deleteItem(e.detail.index);
      },
      _onCartEditItem: function(e) {
        var index = e.detail.index;
        globals.router.set('queryParams', {
          "mode": "edit",
          "index": String(index)
        });
        globals.router.set('route.path', '/detail/' + e.detail.code);
      },
      _getNbItemsLabel: function(nbItems) {
        if (this.localize && nbItems > 0) {
          if (nbItems === 1) {
            return this.localize('basket_item', 'nb', nbItems);
          } else {
            return this.localize('basket_items', 'nb', nbItems);
          }
        } else {
          return '';
        }
      },
      _onCGUChanged: function() {
        var cguBlock = Polymer.dom(this.root).querySelector('.cgu-block');
        if (this.$.cgu.checked) {
          cguBlock.classList.remove('error');
        }
      },
      _openCGU: function() {
        this.$.cgupopin.open();
      },
      _confirm: function() {
        var cguBlock = Polymer.dom(this.root).querySelector('.cgu-block');
        if (this.$.cgu.checked) {
          if (globals.token !== null) {
            // Check authentification
            var login = document.querySelector('planet-kiosk-login-info');
            if (typeof login.villa !== 'undefined' || typeof globals.cottageNumbers !== 'undefined') {
              var number = null;
              var message = this.localize('login_bis_popin_msg');

              if (typeof login.villa !== 'undefined') {
                number = this.localize('login_bis_popin_number', 'number', login.villa);
              }
              else {
                number = globals.cottageNumbers.value.join(', ');
                if (globals.cottageNumbers.value.length > 1) {
                  message = this.localize('login_bis_popin_msg_plural');
                }
              }
              this.$.authentification.set('number', number);
              this.$.authentification.set('message', message);
              this.$.authentification.open();
            }
            else {
              this.doPayment();
            }
          }
        } else {
          cguBlock.classList.add('error');
        }
        this.trackEvent('Basket', 'payment button', 'click', 'noevent');
      },
      _getProducts: function () {
        var products = [];
        this.cart.forEach(function (item) {
          var current = {
            'sku': item.code,
            'name': item.title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ""),
            'category': globals.siteCode + ' - ' + item.date + ' | ' + item.begin,
            'quantity': item.quantity,
            'price': item.unitPrice
          };
          products.push(current);
        });
        return products;
      },
      _trackTransaction: function (data) {              
        var layer = {
          'eventCategory': 'Basket',
          'eventAction': 'purchase',
          'eventLabel': 'transaction',
          'event': 'noevent',
          'transactionId': data.transaction,
          'transactionTotal': data.total.value,
          'transactionProducts': this._getProducts()
        };
        dataLayer.push(layer);
      },
      _success: function(data) {
        var payment = document.querySelector('planet-kiosk-payment');
        payment.set('transaction', data.transaction);
        payment.set('amount', data.total.value);
        payment.set('orderId', data.orderId);
        this._trackTransaction(data);
        globals.router.set('route.path', '/payment');
      },
      _fail: function() {
        this.$.error.open();
        this.trackEvent('Error', 'basket transaction error', this.localize('basket_payment_error_title'), 'noevent');
      },
      _onContentUnavailable : function (activities) {
        activities.forEach(function (activity) {
          var index = activity.itemToken.split('_')[1];
          var item = globals.cart.getItemByIndex(index);
          if (typeof(item) !== 'undefined') {
            item.incorrect = true;
            item.errors = activity.errors;
            globals.cart.editItem(item, index);
            globals.cart.notifyErrorChange(item, index);
          }
        });
      },
      _onBasketResponse: function(e) {
        var response = e.detail.response;
        globals.loader.close();

        if (typeof(response.status) !== 'undefined') {
          var status = response.status;
          var results = response.results;
          switch (status.retC) {
            case 0:
              this._success(results);
              break;
            case -200:
              if (results.activities.length > 0) {
                this._onContentUnavailable(results.activities);
              }
              break;
            case -46:
              if (results.activities.length > 0) {
                this._onContentUnavailable(results.activities);
              }
              break;
            default:
              this._fail();
          }
        } else {
          this._fail();
        }
      },
      _onBasketError: function(e) {
        globals.loader.close();
        this._fail();
      },
      _getParisActivities: function() {
        var activities = [];
        var groups = globals.cart.groupBy('code');
        Object.keys(groups).forEach(function(key) {
          var subSet = {
            "code": key,
            "sessions": groups[key].map(function(item) {
              return {
                "code": item.code,
                "date": item.date,
                "begin": item.begin,
                "duration": item.duration,
                "quantity": item.quantity,
                "itemToken": item.token
              };
            })
          };
          activities.push(subSet);
        });
        return activities;
      },
      doPayment: function() {
        var parisBasket = {
          "activities": this._getParisActivities()
        };
        var body = JSON.stringify(parisBasket);
        var basketRequest = this.$.basketrequest;
        basketRequest.headers = globals.headers;
        basketRequest.body = body;
        basketRequest.params = {
          "token": globals.token,
          "booking": globals.bookingId,
          "kiosk": globals.kioskId
        };
        globals.loader.open();
        basketRequest.generateRequest();
      }
    });
  </script>
</dom-module>