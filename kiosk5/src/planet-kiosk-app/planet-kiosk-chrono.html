<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="planet-kiosk-chrono">
  <template>
    <style include="planet-kiosk-page-styles">
      
      .anticlockwise {
        transform: rotate(-90deg);
      }
      
      path {
        fill: var(--chrono-main-color, --planet-color-algae);        
      }
      
      @keyframes grow { to { stroke-dasharray: 376 376} }
      
      circle {
        fill: none;
        stroke: var(--chrono-alternate-color, --planet-color-softGreen);
        stroke-width: 120;        
        animation-name: grow;
        animation-timing-function: linear;
        animation-iteration-count: 1;        
      }
      
      text {
        font-family: var(--chrono-font-family ,--planet-font-family-heavy);
        fill: var(-chrono-font-color, --planet-color-softGreen);
        font-size: var(--chrono-font-size, 10em);
      }
    </style>
    
    <template is="dom-if" if="{{graphic}}">
      <svg viewBox="0 0 500 500" width$="{{size}}" height$="{{size}}" class="anticlockwise">        
        <path d="m 211.52712,466.78814 c -100,0 -181.299999,-81.3 -181.299999,-181.3 0.1,-99.9 81.399999,-181.2 181.299999,-181.2 99.9,0 181.3,81.3 181.3,181.3 0,99.9 -81.3,181.2 -181.3,181.2 z m 0,-320.2 c -76.6,0 -139,62.4 -139,139 0,76.6 62.4,139 139,139 76.6,0 139,-62.4 139,-139 0,-76.7 -62.3,-139 -139,-139 z"></path>
        <path d="m 298.1484,417.62127 30.4,-30.4 c 1.3,-1.3 3.5,-1.3 4.8,0 l 43.6,43.6 c 1.3,1.3 1.3,3.5 0,4.8 l -30.4,30.4 c -1.3,1.3 -3.5,1.3 -4.8,0 l -43.6,-43.6 c -1.3,-1.3 -1.3,-3.5 0,-4.8 z m 0,-263.19999 30.4,30.4 c 1.3,1.3 3.5,1.3 4.8,0 l 43.6,-43.7 c 1.3,-1.3 1.3,-3.5 0,-4.8 l -30.4,-30.30001 c -1.3,-1.3 -3.5,-1.3 -4.8,0 l -43.6,43.60001 c -1.3,1.4 -1.3,3.5 0,4.8 z m 114.3,110.6 0,42 -39.7,0 0,-42 z m 16.5,66.29999 0,-90.59999 c 0,-1.8 1.5,-3.3 3.3,-3.3 l 41.99999,0 c 1.8,0 3.3,1.5 3.3,3.3 l 0,90.59999 c 0,1.8 -1.5,3.3 -3.3,3.3 l -41.99999,0 c -1.8,0 -3.3,-1.5 -3.3,-3.3 z M 92.048396,286.02128 c -63.000003,-169.26668 -31.5,-84.63333 0,0 z"></path>
        <circle r="60" cx="210" cy="284" stroke-dasharray="0 376"></circle>
      </svg>
    </template>
    
    <template is="dom-if" if="{{!graphic}}">
      <svg viewBox="0 0 500 500" width$="{{size}}" height$="{{size}}">
        <path d="M253.9 479.5c-100 0-181.3-81.3-181.3-181.3C72.7 198.3 154 117 253.9 117s181.3 81.3 181.3 181.3c0 99.9-81.3 181.2-181.3 181.2zm0-320.2c-76.6 0-139 62.4-139 139s62.4 139 139 139 139-62.4 139-139c0-76.7-62.3-139-139-139z"></path>
        <path d="M 385.5,199.4 355.1,169 c -1.3,-1.3 -1.3,-3.5 0,-4.8 l 43.6,-43.6 c 1.3,-1.3 3.5,-1.3 4.8,0 l 30.4,30.4 c 1.3,1.3 1.3,3.5 0,4.8 l -43.6,43.6 c -1.3,1.3 -3.5,1.3 -4.8,0 z m -263.2,0 30.4,-30.4 c 1.3,-1.3 1.3,-3.5 0,-4.8 L 109,120.6 c -1.3,-1.3 -3.5,-1.3 -4.8,0 L 73.9,151 c -1.3,1.3 -1.3,3.5 0,4.8 l 43.6,43.6 c 1.4,1.3 3.5,1.3 4.8,0 z m 110.6,-114.3 42,0 0,39.7 -42,0 z m 66.3,-16.5 -90.6,0 c -1.8,0 -3.3,-1.5 -3.3,-3.3 l 0,-42 c 0,-1.8 1.5,-3.3 3.3,-3.3 l 90.6,0 c 1.8,0 3.3,1.5 3.3,3.3 l 0,42 c 0,1.8 -1.5,3.3 -3.3,3.3 z m -45.3,336.9 c -169.266667,63 -84.63333,31.5 0,0 z"></path>
        <text x="250" y="300" text-anchor="middle" alignment-baseline="central">[[_count]]s</text>
      </svg>
    </template>

  </template>

  <script>
    Polymer({
      is: 'planet-kiosk-chrono',
      properties: {        
        size: {
          type: String,
          value: '150px'
        },
        time: {
          type: Number,
          value: 30
        },
        _handle : Object,
        _count: {
          type: Number
        },
        _offset: {
          type: Number,
          value: 1
        },
        graphic: {
          type: Boolean,
          value: false
        },
        circle: {
          type: Object
        }
      },
      attached: function () {
        this._init();        
      },
      _init: function () {
        this.set('_count', this.get('time'));        
      },
      _nextCount: function () {
        this._count--;        
        if(this._count > 0) {          
          this._handle = this.async(this._nextCount, 1000);
        } else {
          this.stop();          
        }
        // Stop of animation forced before last frame
        if (this._count == 1) {
          this.async(function () {
            if (this.graphic) {   
              this.circle.style.animationPlayState = 'paused';
              this.circle.style.strokeDasharray = "376px 376px";
            }
          }, 500);
        }
      },
      start: function () {
        if(this._count > 0) {
          if (this.graphic) {
            this.circle = Polymer.dom(this.root).querySelector('circle');
            this.circle.style.animationDuration = parseInt(this.get('time') + this.get('_offset')) + 's';          
            this.circle.style.animationPlayState = 'running';          
          }
          this._nextCount();
        }
      },
      stop: function () {
        this.cancelAsync(this._handle);
        if (this.graphic) {          
          this.circle.style.animationPlayState = 'paused';
        }
      },
      reset: function () {
        // TODO Chrono reset
      }
    });
  </script>

</dom-module>