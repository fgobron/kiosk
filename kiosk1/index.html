<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

    <title>planet-kiosk</title>
    <meta name="description" content="planet-kiosk description">
    
    <link rel="icon" href="./images/favicon.ico">

    <link rel="manifest" href="./manifest.json">

    <script src="./bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="./bower_components/moment/min/moment.min.js"></script>
    <script src="./bower_components/moment/locale/fr.js"></script>
    <script src="./bower_components/moment/locale/de.js"></script>
    <script src="./bower_components/moment/locale/nl.js"></script>    
    <script src="./libs/mbird-jssdk-v2.0.0.js"></script>
    <script src="./libs/smoothscroll.js"></script>
    
    <link rel="import" href="./bower_components/polymer/polymer.html">
    
    <link rel="import" href="./bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="./bower_components/iron-meta/iron-meta.html">
    
    <link rel="import" href="./src/planet-kiosk-app/common/planet-kiosk-styles.html">
    <link rel="import" href="./src/planet-kiosk-app/planet-kiosk-services.html">
    <link rel="import" href="./src/planet-kiosk-app/planet-kiosk-app.html">    
  </head>
  <body>
    <template id="app" is="dom-bind">
      <iron-ajax auto url="./appconfig.json" handle-as="json" last-response="{{appconfig}}" on-response="configResponse"></iron-ajax>
      <iron-meta id="appconfig" key="config" value$="{{appconfig}}"></iron-meta>
      <iron-ajax id="subconfig" handle-as="json" on-response="subConfigResponse"></iron-ajax>      
      <iron-ajax id="localWordings" url="./data/getWordings.json" handle-as="json" on-response="localWordingsResponse"></iron-ajax>
      <iron-ajax id="requestWordings" url="[[appconfig.api]]/getWordings?mode=kiosk" on-response="wordingsResponse" on-error="wordingsError"></iron-ajax>
      <planet-kiosk-services id="services"></planet-kiosk-services>
    </template>    
    <script>    
    var globals = {};
    
    if (MBirdSdk.isConnected()) {
      // Change button close      
      var closeImage = "iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABHmAAAR5gH+EeRsAAAAB3RJTUUH4QkcDQUX8G8KAAAAACdJREFUeNrtwQENAAAAwqD3T20ON6AAAAAAAAAAAAAAAAAAAACAdwNAQAABr3oO6AAAAABJRU5ErkJggg==";                 
      var alignment = MBirdSdk.UIAlignment.TopRight;
      var xPadding = 0;
      var yPadding = 0;
      MBirdSdk.UserInterface.CloseButton(alignment, closeImage, xPadding, yPadding)    
      .then(function(result) {
        // Silent success
        //MBirdSdk.Board.ShowNotification("CloseButton debug", JSON.stringify(result), MBirdSdk.NotificationType.HtmlContent, "", false);
      }).catch(function(error) {
        // Silent fail
        //MBirdSdk.Board.ShowNotification("CloseButton debug error", JSON.stringify(error), MBirdSdk.NotificationType.HtmlContent, "", false);
      });
    }
    
    // Service worker registration    
    if('serviceWorker' in navigator) {
      console.log('Delete old registration');
      
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        registrations.forEach(function(v) { console.log(v); v.unregister(); });
      });
      
      navigator.serviceWorker.register('./service-worker.js', { scope: '/kiosk/kiosk1' });
    }
    
    app.connectivity = true;
    
    // Configuration loaded handler ...
    app.configResponse = function() {
      // Retrieving config
      var config = new Polymer.IronMetaQuery({key: 'config'}).value;
      var subConfigRequest = document.getElementById('subconfig');
      globals.services = document.getElementById('services');
      globals.gtmId = config.gtmId;
      subConfigRequest.set('url', config.kiosks);
      subConfigRequest.generateRequest();
    }
    
    app.subConfigResponse = function(e) {
      var subConfig;
      var data = e.detail.response;
      
      // Fetch kioskId      
      globals.services.getNestIdentifier().then(function (nestIdentifier) {        
          subConfig = data[nestIdentifier];
          if (typeof(subConfig) !== 'undefined') {
          // Setting up full        
          var headers = {"dev": "android","lang": subConfig.lang,"osVers": "4.4","reach": "WAN","res": "1080x1920","scheme": "http","wsVers": "1"};        
          globals.language = subConfig.lang;
          globals.headers = headers;
          globals.MBirdNeeded = subConfig.MBirdNeeded;          
          globals.kioskId = subConfig.kiosk;
          globals.siteCode = subConfig.site_code;
          globals.payment = subConfig.payment;
          globals.pmr = subConfig.pmr;
        } else {
          // Setting up fail
          globals.language = 'fr';
          globals.kioskId = -1;
        }
        
        // Requiring Wordings to continue app launch
        var requestWordings = document.getElementById('requestWordings');
        requestWordings.headers = globals.headers;
        requestWordings.generateRequest();
      });
    }
    
    // Fallback local wordings
    app.wordingsFallback = function () {      
      var requestLocalWordings = document.getElementById('localWordings');
      requestLocalWordings.generateRequest();
    }
    
    // Wordings error
    app.wordingsError = function (e) {
      app.wordingsFallback();
      app.connectivity = false;
    }
    
    // i18n managment + app init
    app.wordingsResponse = function (e) {
      try {
        var results = e.detail.response.results;
        if (typeof(results) === 'object' && Object.keys(results).length !== 0) {
          app.init(results);
        } else {
          app.wordingsFallback();
        }
      } catch (e) {
        app.wordingsError(e);
      }      
    }
    
    // local wordings response
    app.localWordingsResponse = function (e) {
      app.init(e.detail.response.results);
    }
    
    app.init = function (results) {
      var appMainElement = document.createElement('planet-kiosk-app');
      appMainElement.setAttribute('language', globals.language);
      globals.resources = results;
      document.body.appendChild(appMainElement);
      globals.token = null;
      globals.bookingId = null;
      globals.lastList = null;      
      globals.loader = document.getElementById('loader');      
      globals.router = document.querySelector('app-route');      
      globals.cart = document.getElementById('cart');
      
      // Tag manager settings
      var tm = document.querySelector('app-tag-manager');
      tm.gtmId = globals.gtmId;
      tm.uid = globals.kioskId + '_' + moment().unix();
      tm.kioskId = globals.kioskId;
      tm.mode = "normal"; // Default vue mode
      tm.lang = globals.language;
      tm.init();      
      
      // Check MBirdSDK initialization if needed            
      var noMBirdSDKNeeded = !globals.MBirdNeeded;
      var correctKiosdId = globals.kioskId !== -1;      
      globals.services.checkEssentialPeripherals().then(function (peripheralsOk){        
        var MBirdOk = globals.MBirdNeeded && MBirdSdk.isConnected() && peripheralsOk;  
        if (app.connectivity && correctKiosdId && (MBirdOk || noMBirdSDKNeeded)) {
          globals.router.set('route.path', '/lang');          
        } else {
          globals.router.set('route.path', '/outage');          
        }
      });
    }
   </script>
  </body>
</html>
