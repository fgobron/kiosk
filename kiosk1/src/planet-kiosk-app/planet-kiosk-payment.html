<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./generic/app-tag-manager-behaviour.html">

<link rel="import" href="./planet-kiosk-activity-behavior.html">
<link rel="import" href="./planet-kiosk-print-behavior.html">
<link rel="import" href="./planet-kiosk-payment-error.html">
<link rel="import" href="./planet-kiosk-printer-error.html">

<dom-module id="planet-kiosk-payment">
  <style include="iron-flex iron-flex iron-flex-alignment planet-kiosk-page-styles">
    .content_pay {
      position: absolute;
      width: 54em;
      height: 38em;
      left: 50%;
      top: 50%;
      margin: -19em 0 0 -27em;
      text-align: center;
    }
    
    .content_success {
      position: absolute;
      width: 92em;
      height: 66em;
      left: 50%;
      top: 50%;
      margin: -33em 0 0 -46em;
      text-align: center;
    }
    
    .message {
      font-size: 4em;
      font-family: var(--planet-font-family-book);
      color: var(--planet-color-theme-message);
      text-align: center;
      margin: 1em 0 2em 0;
    }
    
    .information {
      margin: 5em;
      padding: 2em 3em;
      background-color: var(--planet-color-theme-infobg);
      text-align: left;
    }
  
    .information p.title {
      font-size: 2em;
      font-family: var(--planet-font-family-roman);
      color: var(--planet-color-black);
      font-weight: normal; 
      margin: 0;
    }
    
    .information p {      
      font-size: 2em;
      font-family: var(--planet-font-family-roman);
      color: var(--planet-color-theme-desc);
      padding-left: 0.4em;
      line-height: 1.8em;
      margin: 0;
    }
    
    .buttons {
      margin-top: 10em;
    }
    
  </style>
  <template>    
    <template is="dom-if" if="[[_isEqualToInitial]]">
  
      <h2>[[localize('payment_title')]]</h2>
      
      <div class="content_pay">
        <img src="../../images/paycard.png">
        <p class="message">[[localize('payment_desc')]]</p>
      </div>

    </template>
  
    <template is="dom-if" if="[[_isEqualToSuccess]]">
  
      <h2>[[localize('payment_success_title')]]</h2>
      
      <div class="content_success">
        <img src="../../images/success_tick.png">
        
        <p class="message">[[localize('payment_success_desc')]]</p>
        
        <div class="information">
          <p class="title">[[localize('payment_ticket_title')]]</p>
          <p>[[localize('payment_ticket_desc')]]</p>
        </div>
      
        <div class="buttons">      
        <paper-button class="primary confirm" on-tap="_successEnd">[[localize('payment_success_button_end')]]</paper-button>  
        </div>
        
      </div>      
    </template>
    
    <iron-meta-query id="appconfig" key="config" value="{{appconfig}}"></iron-meta-query>
    <iron-ajax id="transactionrequest" method="POST" content-type="application/x-www-form-urlencoded" url="[[appconfig.api]]/setBookingParisTransaction" on-response="_onTransactionResponse" on-error="_onTransactionError"></iron-ajax>
    <iron-ajax id="cancelrequest" method="POST" content-type="application/x-www-form-urlencoded" url="[[appconfig.api]]/cancelBookingTransaction" on-response="_onCancelResponse" on-error="_onCancelError"></iron-ajax>
    
    <planet-kiosk-payment-error id="paymenterror" with-backdrop="" no-cancel-on-outside-click=""></planet-kiosk-payment-error>
    <planet-kiosk-printer-error id="printererror" with-backdrop="" no-cancel-on-outside-click=""></planet-kiosk-printer-error>
  
  </template>

  <script>  
  Polymer({
    is: 'planet-kiosk-payment',
    behaviors: [
      AppLocalizeBehavior,
      TagManagerBehavior,
      ActivityBehavior,
      PrintBehavior,
    ],
    properties: {
      // State : initial, success
      state: {
        type: String,
        value: 'initial'        
      },      
      visible: Boolean,
      amount: Number,
      transaction: String,
      paymentInfo: Object,
      printInfo: Object,
      orderId: String,
      counterMarks: Object,
      notifications: String,
      _isEqualToInitial: {
        type: String,
        computed:'_isEqualTo(state, "initial")'
      },
      _isEqualToSuccess: {
        type: String,
        computed:'_isEqualTo(state, "success")'
      }
    },
    observers: [
      '_visibiltyChanged(visible)'
    ],
    _isEqualTo : function (state, value) {
      return state === value;
    },
    _visibiltyChanged : function (visible) {  
      if (visible && this.state === 'initial') {
        this.async(function() {
          this.pay();
        }, 1200);
      }
    },
    pay: function () {      
      var amount = this.get('amount');
      var transaction = this.get('transaction');
      if (MBirdSdk.isConnected()) {
        MBirdSdk.Payment.Pay(amount, transaction).then(function (result) {
          this.set('paymentInfo', result);          
          this._setTransaction();
        }.bind(this)).catch(function (error) {          
          this._fail();
        }.bind(this));
      } else {
        this._fail();
      }      
    },
    cancel: function () {
      this._cancelTransaction();
    },
    _onTransactionResponse: function (e) {
      var response = e.detail.response;
      if (typeof(response.status) !== 'undefined') {
        var status = response.status;
        var results = response.results;        
        switch (status.retC) {
          case 0:
            this.set('counterMarks', results);
            this._success();            
            break;          
          default:
            this._fail();
        }
      } else {
        this._fail();
      }
    },
    _onTransactionError: function (e) {
      this._fail();
    },
    _setTransaction: function () {
      var transactionrequest = this.$.transactionrequest;      
      var data = 'token=' + globals.token + '&booking=' + globals.bookingId + '&transaction=' + this.get('transaction') + '&kiosk=' + globals.kioskId;
      transactionrequest.headers = globals.headers;
      transactionrequest.body = data;      
      transactionrequest.generateRequest();      
    },
    _onCancelResponse: function (e) {
      // silent success
      // TODO : tracking (GA?)      
    },
    _onCancelError: function (e) {
      // silent fail
      // TODO : tracking (GA?)      
    },
    _cancelTransaction: function () {
      var transactionrequest = this.$.cancelrequest;      
      var data = 'token=' + globals.token + '&booking=' + globals.bookingId + '&transaction=' + this.get('transaction') + '&orderId=' + this.get('orderId');
      transactionrequest.headers = globals.headers;
      transactionrequest.body = data;      
      transactionrequest.generateRequest();
      this.trackEvent('Payment', 'cancel transaction', this.get('transaction'), 'noevent');
    },
    _success: function () {
      this.set('state', 'success');
      this.async(this._successEnd, 60000);
      this.async(function() {
          this._print();
      }, 1200);      
    },
    _printFail: function () {
      this.$.printererror.open();
      this.trackEvent('Error', 'print error', this.localize('printer_error_title'), 'noevent');
    },
    _print: function () {
      if (MBirdSdk.isConnected()) {
        var printContent = this._getAllContent();
        MBirdSdk.Printer.TagContent(printContent).then(function (result) {          
          this.set('printInfo', result);          
        }.bind(this)).catch(function (error) {          
          this._printFail();
        }.bind(this));
      } else {
        this._printFail();
      }
    },
    _getAllContent: function () {
      var content = '';

      content += this._getCBContent();
      content += this._getCartContent();
      content += this._getCounterMarks();

      return content;
    },    
    _getCBContent: function () {
      return this.customerReceipt();
    },
    _getCartContent: function () {
      var header = this.localize('payment_ticket_cart_title');
      var currency = this.localize('activity_currency');
      var totalLbl = this.localize('payment_ticket_cart_total_label');

      var headerContent = [
        this.localize('printer_basket_product_label_ml_25'),
        this.localize('printer_basket_product_quantity_ml_2'),
        this.localize('printer_basket_product_unit_price_ml_6'),
        this.localize('printer_basket_product_total_ml_6')
      ];

      var layout = [ // TODO : Potentially externalize or calc size dynamiclly
        { size:25 },
        { size:2, align:'right' },
        { size:6, align:'right' },
        { size:6, align:'right' }
      ];

      var content = this.partialCut() + this.center(header) + this.cr + this.cr;
      var cartItems = globals.cart.get('cart');

      var cartArray = [{ content: headerContent, bold: true, underline: false }];

      cartArray = cartArray.concat(cartItems.map(function (item) {
        return {content: [item.title,  item.quantity, item.unitPrice, item.price]};
      }));

      content += this.array(cartArray, layout);

      var total = globals.cart.get('total') + currency;

      content += this.cr + this.bold(this.alignRight(totalLbl + total));
      content += this.cr + this.cr;
      return content;
    },    
    _getCounterMarks: function () {
      var content = '';
      var counterMarks = this.get('counterMarks');

      for (var i = 0; i < counterMarks.length; i++) {
        content += this.partialCut();
        content += this._getCounterMark(counterMarks[i]);
      }

      content += this.partialCut();
      return content;
    },
    _getCounterMark : function(counterMark) {
      var content = '';
      var title = counterMark.title;
      var date = counterMark.date;
      var hour = counterMark.hour;
      var location = counterMark.location;
      var counterMarkQuantity =  this.localize('printer_counter_mark_quantity', 'quantity', counterMark.quantity);
      var timeLine = date + ' ' + moment(hour, 'HH:mm:ss').format('HH:mm');

      if (counterMark.duration) {
        timeLine += ' - ' + moment(hour, 'HH:mm:ss').add(counterMark.duration, 'm').format('HH:mm');
      }

      content += this.localize('printer_counter_mark_header') + this.cr + this.cr;
      content += this.magnification(2,  title) + this.cr + this.cr + this.cr;
      content += this.bold(this.center(timeLine)) + this.cr;
      content += this.center(counterMarkQuantity) + this.cr;

      if (location) {
        content += this.bold(this.center(location)) + this.cr;
      }

      content += this.center(counterMark.cottageNumbers.title + ' ' + counterMark.cottageNumbers.label);
      content += this.barcode('QRCode', counterMark.code);
      content += this.bold(this.center(counterMark.code)) + this.cr;

      if (counterMark.conditions) {
        content +=  this.cr + this.smaller(counterMark.conditions);
      }

      return content;
    },
    _fail: function () {
      this.$.paymenterror.open();
      this.trackEvent('Error', 'payment error', this.localize('payment_error_title'), 'noevent');
    },
    _successEnd: function () {
      document.location.reload(true);
    }
  });

  </script>
</dom-module>