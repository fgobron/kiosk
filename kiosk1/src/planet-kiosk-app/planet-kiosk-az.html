<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./common/planet-kiosk-scroll-behavior.html">
<link rel="import" href="./planet-kiosk-activity.html">
<link rel="import" href="./planet-kiosk-alphaselector.html">

<dom-module id="planet-kiosk-az">
  <template>
  <style include="planet-kiosk-page-styles">
    :host {
      --info-pres : {
        font-size: 1.7em;
        font-family: var(--planet-font-family-book);
        padding-left: 0.4em;
     }
    }
      
    .content {
      display: block;
      margin: 9em 10em 19em 5em;
    }
    
    header {
      font-size: 5em;
      font-family: var(--planet-font-family-book);
      color: var(--planet-color-theme-desc);      
      margin: 1em 0;      
      border-bottom: 1px solid var(--planet-color-coolGrey);
      
    }
    
    header a {
      padding-top: 1.2em;
      text-decoration:none;
      color: inherit;
    }
    
    planet-kiosk-alphaselector {
      position: fixed;
      right: 3em;
      top: 25em;
    }

  </style>
  
  <h2>[[localize('az_title')]]</h2>
  <p class="sub-title">[[localize('az_desc')]]</p>
  
  <div class="content">
      <template id="list" is="dom-repeat" items="{{activities}}" sort="_sort">
        <template is="dom-if" if="[[_isNewLetter(item)]]">
          <header><a href="#[[_getFirstLetter(item)]]">[[_getFirstLetter(item)]]</a></header>
        </template>
        <planet-kiosk-activity activity="[[item]]" display="column">
        </planet-kiosk-activity>
      </template>
  </div>
  
  </template>

  <script>

  Polymer({
    is: 'planet-kiosk-az',
    behaviors: [
      AppLocalizeBehavior,
      ActivityBehavior,
      ScrollBehavior
    ],
    properties: {
      activities: {
        type: Object,
        observer: '_activitiesFetched'
      }
    },
    attributeChanged: function(name, type) {
      // Check visibility of the list and attach or remove handler
      if (name === 'visible') {
        if (this.getAttribute(name) !== null) {
          var alphaSelector = document.querySelector('planet-kiosk-alphaselector');        
          alphaSelector.highLightFirstLetter();
          this._attachScrollHandler();
          this._scrollHandler();
        } else {
          this._detachScrollHandler();  
        }
      }
    },
    _attachScrollHandler: function () {
      window.addEventListener('scroll', this._scrollHandler);
    },
    _detachScrollHandler: function ()  {
      window.removeEventListener('scroll', this._scrollHandler);
    },    
    _sort: function(a, b) {  
      if (a.title === b.title) return 0;
      return a.title.localeCompare(b.title);
    },
    _isNewLetter : function (item) {
      var firstLetter = this._getFirstLetter(item);
      if (this.firstLetterPrevious !== firstLetter) {
        this.firstLetterPrevious = firstLetter;                
        return 1;
      }      
      return 0;
    },
    _getFirstLetter: function (item) {
      return item.title.substr(0,1);
    },
    _activitiesFetched: function () {
      var activities = this.get('activities').slice(0);
      var activeLetters = [];
      var activity = {};
      
      activities.sort(this._sort);
      
      for (var property in activities) {  
        if (activities.hasOwnProperty(property)) {
            activity = activities[property];            
            if (this._isNewLetter(activity)) {              
              activeLetters.push(this._getFirstLetter(activity));
            }
        }
      }      
      this._addAlphaSelector(activeLetters);
    },
    _addAlphaSelector: function (activeLetters) {
      var alphaSelector = document.createElement('planet-kiosk-alphaselector');
      alphaSelector.setAttribute('active-letters', JSON.stringify(activeLetters));
      Polymer.dom(this.root).appendChild(alphaSelector);      
    },
    _scrollHandler: function () {
      var headers = document.querySelectorAll('planet-kiosk-az header');
      var alphaSelector = document.querySelector('planet-kiosk-alphaselector');
      var doc = document.documentElement;      
      var top = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);      
      // Check which header has reached the top
      [].forEach.call(headers, function (header) {        
        var coords = header.getBoundingClientRect();
        var top = coords.top;
        if (top <= 100) {
          alphaSelector.highLightLetter(header.innerText);            
        }        
      });
      // Check bottom of the page
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
        alphaSelector.highLightLastLetter();
      }
		}
  });

  </script>
</dom-module>