<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="./generic/app-localize-behavior.html">
<link rel="import" href="./generic/app-tag-manager-behaviour.html">

<dom-module id="planet-kiosk-lang-block">
  <template>
    <style>
      .card-container {
        display: inline-block;
        text-decoration: none;
        margin: 0 0 5em 5em;
      }
      
      .card-container:active {        
        transform: scale(0.98);
      }
  
      paper-card {
        display: block;             
        width: 46.5em;
        height: 52em;
        border-radius: 1em;
      }
      
      .card-content {
        text-align: center;
        padding-top: 18.5em;
      }
  
      .card-content h3 {
        font-size: 4em;
        font-family: var(--planet-font-family-heavy);
        color: var(--planet-color-theme-title);
      }
    </style>    
    
    <a class="card-container" href="#/hub">
      <paper-card elevation="3">
        <div class="card-content">
          <img src="./images/[[lang}}.png">
          <h3>[[_getBlockTitle(localize, lang)]]</h3>                
        </div>              
      </paper-card>
    </a>
    
  <iron-meta-query id="appconfig" key="config" value="{{appconfig}}"></iron-meta-query>
  <iron-ajax id="activitiesrequest" url="[[appconfig.api]]/getBookingParisActivities?lang=[[language]]&amp;timestamp=[[_getTimestamp()]]&amp;dateFrom=[[_getDateFrom()]]&amp;dateTo=[[_getDateTo()]]" on-response="_onActivitiesResponse" last-response="{{activities}}" on-error="_onActivitiesError"></iron-ajax> 
  </template>

  <script>  
  Polymer({
    is: 'planet-kiosk-lang-block',
    behaviors: [
      AppLocalizeBehavior,
      TagManagerBehavior
    ],
    listeners: {
        'tap': '_changeLanguage',
    },
    properties: {
      lang: {
        type: String
      },
      activities: Object
    },
    _changeLanguage: function (e) {
      e.preventDefault();      
      var main = document.querySelector('planet-kiosk-app');
      globals.language = this.lang;
      main.language = this.lang;
      globals.headers.lang = this.lang;
      moment.locale(this.lang);
      globals.loader.open();
      var activitiesRequest = this.$.activitiesrequest;
      activitiesRequest.headers = globals.headers;
      activitiesRequest.params.siteCode = globals.siteCode;
      var ironRequest = activitiesRequest.generateRequest();
      ironRequest.addEventListener('progress-changed', this._onProgressChanged.bind(this));
      this.setDataLayerItem('language', this.lang);
      this.trackEvent('Language selection', 'choose language', this.lang, 'noevent');      
    },
    _getDateFrom: function () {
      return moment().format('YYYY-MM-DD');
    },
    _getDateTo: function () {
      var dateTo = moment().add(7, 'days');
      return dateTo.format('YYYY-MM-DD');
    },
    _getTimestamp: function() {      
      return moment().format('YYYYMMDDHH');
    },
    _getBlockTitle: function (localize, lang) {      
      return this.localize('language_' + this.lang);
    },
    _getPercentResponse: function (progress) {      
      return Math.round(progress.loaded * 100 / progress.total);
    },
    _onProgressChanged: function (e) {      
      var xhr = e.target;
      globals.loader.progress = this._getPercentResponse(xhr.progress);
    },
    _onActivitiesResponse: function (e) {
      var appMainElement = document.querySelector('planet-kiosk-app');      
      appMainElement.set('activities', e.detail.response.results);
      globals.loader.close();
      globals.loader.set('indeterminate', true);
      globals.router.set('route.path', '/hub');      
    },
    _onActivitiesError: function (e) {
      globals.loader.close();      
      globals.router.set('route.path', '/outage');
    }
  });

  </script>
</dom-module>